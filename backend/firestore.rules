rules_version = '2';

service cloud.firestore {

  // HELPERS
  function isSignedIn() {
    return request.auth != null;
  }

  function isAdmin() {
    return request.auth != null &&
      get(/databases/$(database)/documents/users/$(request.auth.uid)).data.get('isAdmin', false) == true;
  }

  function isOwner() {
    return isSignedIn() && resource != null && resource.data.createdBy == request.auth.uid;
  }

  function isCollaborator() {
    return isSignedIn() && resource != null &&
      resource.data.collaborators != null &&
      request.auth.uid in resource.data.collaborators;
  }

  function validateModule() {
    return request.resource.data.keys().hasAll(['title', 'description', 'createdBy', 'isPublic', 'tags', 'createdAt', 'updatedAt', 'stepCount'])
    && request.resource.data.title is string
    && request.resource.data.description is string
    && request.resource.data.isPublic is bool
    && request.resource.data.tags is list
    && request.resource.data.stepCount is int
    && (!('collaborators' in request.resource.data) || request.resource.data.collaborators is list)
    && (!('publishedVersion' in request.resource.data) || request.resource.data.publishedVersion is int)
    && (!('thumbnailUrl' in request.resource.data) || request.resource.data.thumbnailUrl is string);
  }

  function validateProgress() {
    return request.resource.data.keys().hasAll(['completedStepIds', 'lastViewedAt', 'quizScores', 'startedAt', 'completedAt'])
    && request.resource.data.completedStepIds is list
    && request.resource.data.quizScores is map
    && request.resource.data.lastViewedAt is timestamp
    && request.resource.data.startedAt is timestamp
    && (request.resource.data.completedAt == null || request.resource.data.completedAt is timestamp);
  }

  function validateStep() {
    return request.resource.data.keys().hasAll(['title', 'type', 'order', 'createdBy', 'createdAt', 'updatedAt'])
    && request.resource.data.title is string
    && request.resource.data.type in ['video', 'quiz', 'flashcards', 'freeResponse']
    && request.resource.data.order is int
    && request.resource.data.createdBy is string
    && hasMatchingPayloadType()
    && validatePayload();
  }

  function hasMatchingPayloadType() {
    let t = request.resource.data.type;
    return (t == 'video' && 'youtubeUrl' in request.resource.data) || (t == 'quiz' && 'questions' in request.resource.data) || (t == 'flashcards' && 'cards' in request.resource.data) || (t == 'freeResponse' && 'prompt' in request.resource.data);
  }

  function validatePayload() {
    let t = request.resource.data.type;
    return (t == 'video' && validateVideoPayload()) || (t == 'quiz' && validateQuizPayload()) || (t == 'flashcards' && validateFlashcardsPayload()) || (t == 'freeResponse' && validateFreeResponsePayload());
  }

  function validateVideoPayload() {
    let d = request.resource.data;
    return d.youtubeUrl is string
      && (!('thumbnailUrl' in d) || d.thumbnailUrl is string)
      && (!('durationSec' in d) || d.durationSec is int);
  }

  function validateQuizPayload() {
    let d = request.resource.data;
    return d.shuffle is bool
      && d.questions is list
      && d.questions.size() > 0
      && d.questions[0].prompt is string
      && d.questions[0].choices is list
      && d.questions[0].correctIndex is int
      && (!('explanation' in d.questions[0]) || d.questions[0].explanation is string)
      && d.passingScore is int
      && d.passingScore >= 0
      && d.passingScore <= 100;
  }

  function validateFlashcardsPayload() {
    let d = request.resource.data;
    return d.cards is list
      && d.cards.size() > 0
      && d.cards[0].front is string
      && d.cards[0].back is string
      && (!('studyMode' in d) || d.studyMode in ['spaced', 'random']);
  }

  function validateFreeResponsePayload() {
    let d = request.resource.data;
    return d.prompt is string
      && (!('sampleAnswer' in d) || d.sampleAnswer is string)
      && (!('maxLength' in d) || (d.maxLength is int && d.maxLength > 0 && d.maxLength <= 10000));
  }

  function validateStepUpdate() {
    let allowedFields = [
      'title',
      'type',
      'order',
      'updatedAt',
      'createdBy',
      'createdAt',
      'estimatedMinutes',
      'isOptional',
      // Video fields
      'youtubeUrl',
      'thumbnailUrl',
      'durationSec',
      // Quiz fields
      'shuffle',
      'questions',
      'passingScore',
      // Flashcards fields
      'cards',
      'studyMode',
      // FreeResponse fields
      'prompt',
      'sampleAnswer',
      'maxLength'
    ];
    return request.resource.data.keys().hasOnly(allowedFields)
      && request.resource.data.diff(resource.data).affectedKeys().size() > 0
      && (
        !('title' in request.resource.data) || request.resource.data.title is string
      )
      && (
        !('order' in request.resource.data) || request.resource.data.order is int
      )
      && (
        !('updatedAt' in request.resource.data) || request.resource.data.updatedAt is timestamp
      )
      && (
        !('type' in request.resource.data) || request.resource.data.type in ['video', 'quiz', 'flashcards', 'freeResponse']
      )
      && (
        resource.data.createdBy == request.resource.data.createdBy
      )
      && (
        resource.data.createdAt == request.resource.data.createdAt
      );
  }

  function validateModuleUpdate() {
    let allowedFields = [
      'title',
      'description',
      'isPublic',
      'tags',
      'updatedAt',
      'stepCount',
      'publishedVersion',
      'thumbnailUrl',
      'collaborators',
      'createdBy',
      'createdAt'
    ];
    return request.resource.data.keys().hasOnly(allowedFields)
      && request.resource.data.diff(resource.data).affectedKeys().size() > 0
      && (
        !('title' in request.resource.data) || request.resource.data.title is string
      )
      && (
        !('description' in request.resource.data) || request.resource.data.description is string
      )
      && (
        !('isPublic' in request.resource.data) || request.resource.data.isPublic is bool
      )
      && (
        !('tags' in request.resource.data) || request.resource.data.tags is list
      )
      && (
        !('stepCount' in request.resource.data) || request.resource.data.stepCount is int
      )
      && (
        !('publishedVersion' in request.resource.data) || request.resource.data.publishedVersion is int
      )
      && (
        !('thumbnailUrl' in request.resource.data) || request.resource.data.thumbnailUrl is string
      )
      && (
        !('collaborators' in request.resource.data) || request.resource.data.collaborators is list
      )
      && resource.data.createdBy == request.resource.data.createdBy
      && resource.data.createdAt == request.resource.data.createdAt;
  }

  match /databases/{database}/documents {

    // MODULES
    match /modules/{moduleId} {
      allow read: if (resource != null && resource.data.isPublic == true) || isOwner() || isCollaborator() || isAdmin();
      allow create: if isSignedIn() && validateModule() && request.resource.data.createdBy == request.auth.uid;
      allow update: if isAdmin() || ((isOwner() || isCollaborator()) && validateModuleUpdate());
      allow delete: if isAdmin() || isOwner() || isCollaborator();

      // VIDEO STEPS
      match /videos/{videoId} {
        allow read: if get(/databases/$(database)/documents/modules/$(moduleId)).data.isPublic == true || isOwner() || isCollaborator() || isAdmin();
        allow create: if isSignedIn() &&
          (get(/databases/$(database)/documents/modules/$(moduleId)).data.createdBy == request.auth.uid ||
           request.auth.uid in get(/databases/$(database)/documents/modules/$(moduleId)).data.collaborators) &&
          validateStep();
        allow update: if (isOwner() || isCollaborator() || isAdmin()) && validateStepUpdate();
        allow delete: if isOwner() || isCollaborator() || isAdmin();
      }

      // QUIZ STEPS
      match /quizzes/{quizId} {
        allow read: if get(/databases/$(database)/documents/modules/$(moduleId)).data.isPublic == true || isOwner() || isCollaborator() || isAdmin();
        allow create: if isSignedIn() &&
          (get(/databases/$(database)/documents/modules/$(moduleId)).data.createdBy == request.auth.uid ||
           request.auth.uid in get(/databases/$(database)/documents/modules/$(moduleId)).data.collaborators) &&
          validateStep();
        allow update: if (isOwner() || isCollaborator() || isAdmin()) && validateStepUpdate();
        allow delete: if isOwner() || isCollaborator() || isAdmin();
      }

      // FLASHCARD STEPS
      match /flashcards/{flashcardId} {
        allow read: if get(/databases/$(database)/documents/modules/$(moduleId)).data.isPublic == true || isOwner() || isCollaborator() || isAdmin();
        allow create: if isSignedIn() &&
          (get(/databases/$(database)/documents/modules/$(moduleId)).data.createdBy == request.auth.uid ||
           request.auth.uid in get(/databases/$(database)/documents/modules/$(moduleId)).data.collaborators) &&
          validateStep();
        allow update: if (isOwner() || isCollaborator() || isAdmin()) && validateStepUpdate();
        allow delete: if isOwner() || isCollaborator() || isAdmin();
      }

      // FREE RESPONSE STEPS
      match /freeResponses/{freeResponseId} {
        allow read: if get(/databases/$(database)/documents/modules/$(moduleId)).data.isPublic == true || isOwner() || isCollaborator() || isAdmin();
        allow create: if isSignedIn() &&
          (get(/databases/$(database)/documents/modules/$(moduleId)).data.createdBy == request.auth.uid ||
           request.auth.uid in get(/databases/$(database)/documents/modules/$(moduleId)).data.collaborators) &&
          validateStep();
        allow update: if (isOwner() || isCollaborator() || isAdmin()) && validateStepUpdate();
        allow delete: if isOwner() || isCollaborator() || isAdmin();
      }
    }

    // USERS
    match /users/{userId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow update, delete: if request.auth.uid == userId;

      // PROGRESS
      match /progress/{moduleId} {
        allow write: if isSignedIn() && request.auth.uid == userId && validateProgress();
        allow read: if isSignedIn() && request.auth.uid == userId;
      }
    }
  }
}